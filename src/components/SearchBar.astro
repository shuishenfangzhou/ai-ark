---
// src/components/SearchBar.astro
// 基于 Pagefind 的即时搜索组件
---
<div class="relative" id="search-container">
    <!-- 搜索输入框 -->
    <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>
        <label for="search-input" class="sr-only">搜索 AI 工具</label>
        <input
            type="text"
            id="search-input"
            class="block w-full pl-12 pr-10 py-3 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm"
            placeholder="搜索 AI 工具... (支持中文、英文、标签)"
            autocomplete="off"
        />
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <kbd class="hidden sm:inline-block px-2 py-1 text-xs text-slate-400 bg-slate-100 rounded">Ctrl K</kbd>
        </div>
    </div>
    
    <!-- 搜索结果下拉框 -->
    <div id="search-results" class="hidden absolute z-50 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden">
        <!-- 结果统计 -->
        <div class="px-4 py-2 bg-slate-50 border-b border-slate-100">
            <span id="results-count" class="text-sm text-slate-500">找到 <strong class="text-slate-700">0</strong> 个结果</span>
        </div>
        
        <!-- 结果列表 -->
        <div id="results-list" class="max-h-96 overflow-y-auto">
            <!-- 结果项由 JS 动态生成 -->
        </div>
        
        <!-- 底部操作 -->
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
            <span class="text-xs text-slate-400">Powered by Pagefind</span>
            <a href="/search?q=" id="view-all-link" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                查看全部结果 →
            </a>
        </div>
    </div>
    
    <!-- Loading 状态 -->
    <div id="search-loading" class="hidden absolute inset-y-0 right-12 flex items-center">
        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
</div>

<script>
    // Pagefind 搜索实现
    class SearchEngine {
        constructor() {
            this.input = document.getElementById('search-input');
            this.resultsBox = document.getElementById('search-results');
            this.resultsList = document.getElementById('results-list');
            this.resultsCount = document.getElementById('results-count');
            this.loading = document.getElementById('search-loading');
            this.viewAllLink = document.getElementById('view-all-link');
            this.pagefind = null;
            this.debounceTimer = null;
            this.isOpen = false;
            
            this.init();
        }
        
        async init() {
            // 等待 Pagefind 加载
            if (window.pagefind) {
                this.pagefind = window.pagefind;
            } else {
                // 监听 Pagefind 加载完成
                window.addEventListener('pagefind-loaded', () => {
                    this.pagefind = window.pagefind;
                });
                
                // 尝试加载 Pagefind
                await this.loadPagefind();
            }
            
            // 绑定事件
            this.bindEvents();
        }
        
        async loadPagefind() {
            // 动态加载 Pagefind 脚本
            if (!document.querySelector('script[src*="pagefind"]')) {
                const script = document.createElement('script');
                script.src = '/pagefind/pagefind-ui.js';
                script.onload = () => {
                    // 初始化 Pagefind UI
                    new PagefindUI({
                        element: this.input,
                        showSubResults: true,
                        showImages: false,
                        resetStyles: false,
                    });
                };
                document.head.appendChild(script);
            }
        }
        
        bindEvents() {
            // 输入事件（防抖）
            this.input?.addEventListener('input', (e) => {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.search(e.target.value);
                }, 300);
            });
            
            // 聚焦事件
            this.input?.addEventListener('focus', () => {
                if (this.input.value.trim()) {
                    this.showResults();
                }
            });
            
            // 失去焦点事件（延迟隐藏，允许点击结果）
            this.input?.addEventListener('blur', () => {
                setTimeout(() => this.hideResults(), 200);
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                // Ctrl+K 聚焦搜索
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    this.input?.focus();
                }
                
                // ESC 关闭结果
                if (e.key === 'Escape' && this.isOpen) {
                    this.hideResults();
                    this.input?.blur();
                }
                
                // 方向键导航（简化版）
                if (this.isOpen && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
                    this.navigateResults(e.key === 'ArrowDown' ? 1 : -1);
                }
                
                // Enter 跳转
                if (this.isOpen && e.key === 'Enter') {
                    const firstResult = this.resultsList?.querySelector('a');
                    firstResult?.click();
                }
            });
        }
        
        async search(query) {
            if (!query.trim()) {
                this.hideResults();
                return;
            }
            
            // 显示 loading
            this.loading?.classList.remove('hidden');
            
            try {
                // 使用 Pagefind 搜索
                if (this.pagefind) {
                    const results = await this.pagefind.search(query, {
                        limit: 10,
                    });
                    
                    // 获取详细结果
                    const detailedResults = await Promise.all(
                        results.results.slice(0, 5).map(r => r.data())
                    );
                    
                    this.renderResults(detailedResults, results.totalCount);
                } else {
                    // 降级方案：简单过滤（当 Pagefind 不可用时）
                    this.simpleSearch(query);
                }
            } catch (error) {
                console.error('搜索失败:', error);
                this.simpleSearch(query);
            } finally {
                this.loading?.classList.add('hidden');
            }
        }
        
        simpleSearch(query) {
            // 简单的本地搜索（降级方案）
            const tools = window.__SEARCH_INDEX__ || [];
            const results = tools.filter(tool => 
                tool.name?.toLowerCase().includes(query.toLowerCase()) ||
                tool.description?.toLowerCase().includes(query.toLowerCase()) ||
                tool.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 5);
            
            this.renderResults(results, results.length);
        }
        
        renderResults(results, totalCount) {
            if (!this.resultsList) return;
            
            // 更新计数
            if (this.resultsCount) {
                this.resultsCount.innerHTML = `找到 <strong class="text-slate-700">${totalCount}</strong> 个结果`;
            }
            
            // 更新"查看全部"链接
            if (this.viewAllLink) {
                this.viewAllLink.href = `/search?q=${encodeURIComponent(this.input.value)}`;
            }
            
            // 渲染结果列表
            if (results.length === 0) {
                this.resultsList.innerHTML = `
                    <div class="px-4 py-8 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-slate-500">未找到相关工具</p>
                        <p class="text-sm text-slate-400 mt-1">试试其他关键词</p>
                    </div>
                `;
            } else {
                this.resultsList.innerHTML = results.map((result, index) => `
                    <a href="${result.url || '#'}" 
                       class="block px-4 py-3 hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-b-0"
                       data-index="${index}">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white flex-shrink-0">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-slate-900 truncate">${result.name || '未知工具'}</h4>
                                <p class="text-sm text-slate-500 line-clamp-2 mt-0.5">${result.description || ''}</p>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${(result.tags || []).slice(0, 3).map(tag => `
                                        <span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full">${tag}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('');
            }
            
            this.showResults();
        }
        
        showResults() {
            this.resultsBox?.classList.remove('hidden');
            this.isOpen = true;
        }
        
        hideResults() {
            this.resultsBox?.classList.add('hidden');
            this.isOpen = false;
        }
        
        navigateResults(direction) {
            const items = this.resultsList?.querySelectorAll('a');
            if (!items?.length) return;
            
            const currentActive = this.resultsList.querySelector('a:focus');
            const currentIndex = Array.from(items).indexOf(currentActive);
            
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = items.length - 1;
            if (newIndex >= items.length) newIndex = 0;
            
            items[newIndex]?.focus();
        }
    }
    
    // 初始化搜索
    document.addEventListener('DOMContentLoaded', () => {
        new SearchEngine();
    });
</script>

<style>
    /* 搜索组件样式增强 */
    #search-container {
        --pagefind-ui-scale: 0.875;
        --pagefind-ui-primary: #3b82f6;
        --pagefind-ui-text: #1e293b;
        --pagefind-ui-background: #ffffff;
        --pagefind-ui-border: #e2e8f0;
        --pagefind-ui-tag: #f1f5f9;
        --pagefind-ui-border-width: 1px;
        --pagefind-ui-border-radius: 0.75rem;
        --pagefind-ui-image-border-radius: 0.5rem;
        --pagefind-ui-image-box-ratio: 3 / 2;
        --pagefind-ui-font: inherit;
    }
    
    #search-results {
        animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
