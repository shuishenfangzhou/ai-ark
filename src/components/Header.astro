---
// src/components/Header.astro
import toolsData from '../../data/tools.json';
const allTools = toolsData.tools;

// 获取所有唯一分类
const categories = [...new Set(allTools.map(t => t.category))];
---

<!-- Header -->
<header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
            <!-- Logo -->
            <div class="flex items-center cursor-pointer space-x-3" onclick="window.location.reload()">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-rocket text-xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-xl tracking-tight text-slate-900">AI方舟</span>
                    <span class="text-[10px] text-blue-500 font-medium tracking-wide">AIArk.com</span>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="hidden md:flex flex-1 max-w-2xl mx-8">
                <div class="relative w-full group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    </div>
                    <label for="global-search" class="sr-only">搜索 AI 工具、分类、功能</label>
                    <input type="text" id="global-search"
                           class="block w-full pl-11 pr-14 py-2.5 border border-slate-200 rounded-xl leading-5 bg-slate-50/50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                           placeholder="搜索 AI 工具、分类、功能...">
                    <button 
                        type="button"
                        id="search-btn"
                        class="absolute inset-y-1 right-1 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center justify-center cursor-pointer"
                    >
                        <i class="fa-solid fa-magnifying-glass text-sm"></i>
                    </button>
                </div>
                <!-- Search Results Dropdown -->
                <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-50" style="max-width: 42rem; left: 50%; transform: translateX(-50%);">
                    <div class="px-4 py-2 bg-slate-50 border-b border-slate-100">
                        <span id="results-count" class="text-sm text-slate-500">找到 <strong class="text-slate-700">0</strong> 个结果</span>
                    </div>
                    <div id="results-list" class="max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center space-x-2">
                <!-- Mobile Sidebar Trigger -->
                <button id="mobile-sidebar-trigger" class="lg:hidden flex items-center justify-center w-10 h-10 rounded-lg hover:bg-slate-100 transition">
                    <i class="fa-solid fa-bars text-slate-600"></i>
                </button>
                
                <!-- Compare Button -->
                <button id="compare-btn" class="hidden lg:flex items-center px-3 py-2 text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium relative">
                    <i class="fa-solid fa-scale-balanced mr-2"></i>
                    对比
                    <span id="compare-count" class="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                
                <!-- Favorites -->
                <button id="favorites-btn" class="hidden lg:flex items-center px-3 py-2 text-slate-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition text-sm font-medium">
                    <i class="fa-regular fa-heart mr-2"></i>
                    收藏
                </button>
                
                <!-- Submit Tool -->
                <button class="hidden lg:flex items-center px-3 py-2 text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-plus-circle mr-2"></i>
                    提交
                </button>
                
                <!-- 合并按钮：关注加入 -->
                <button onclick="window.openWechatModal()" class="hidden sm:flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-full transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fa-brands fa-weixin text-lg"></i>
                    <span class="font-medium text-sm">关注加入</span>
                </button>
            </div>
        </div>
    </div>
</header>

<script define:vars={{ allTools }}>
    // 搜索实现
    class SearchEngine {
        constructor() {
            this.input = document.getElementById('global-search');
            this.resultsBox = document.getElementById('search-results');
            this.resultsList = document.getElementById('results-list');
            this.resultsCount = document.getElementById('results-count');
            this.debounceTimer = null;
            this.isOpen = false;
            this.toolsIndex = allTools;
            
            this.bindEvents();
        }
        
        bindEvents() {
            // 输入事件（防抖）
            this.input?.addEventListener('input', (e) => {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.search(e.target.value);
                }, 200);
            });
            
            // 聚焦事件
            this.input?.addEventListener('focus', () => {
                if (this.input.value.trim()) {
                    this.showResults();
                }
            });
            
            // 按钮点击事件
            const searchBtn = document.getElementById('search-btn');
            searchBtn?.addEventListener('click', () => {
                if (this.input.value.trim()) {
                    this.search(this.input.value);
                    this.showResults();
                    this.input.focus();
                }
            });
            
            // 点击外部关闭
            document.addEventListener('click', (e) => {
                if (!this.resultsBox?.contains(e.target) && e.target !== this.input && e.target !== searchBtn) {
                    this.hideResults();
                }
            });
            
            // 键盘快捷键（保留Enter键触发搜索）
            this.input?.addEventListener('keydown', (e) => {
                // Enter 键触发搜索
                if (e.key === 'Enter') {
                    if (this.input.value.trim()) {
                        this.search(this.input.value);
                        this.showResults();
                    }
                }
                
                // ESC 关闭结果
                if (e.key === 'Escape' && this.isOpen) {
                    this.hideResults();
                    this.input.blur();
                }
            });
        }
        
        search(query) {
            if (!query.trim()) {
                this.hideResults();
                // 广播重置事件
                window.dispatchEvent(new CustomEvent('toolSearch', { detail: null }));
                return;
            }
            
            const q = query.toLowerCase();
            const results = this.localSearch(q);
            this.renderResults(results, results.length);
            
            // 广播搜索结果到工具列表
            window.dispatchEvent(new CustomEvent('toolSearch', { detail: results }));
        }
        
        localSearch(query) {
            return this.toolsIndex.filter(tool => 
                tool.name?.toLowerCase().includes(query) ||
                tool.description?.toLowerCase().includes(query) ||
                tool.category?.toLowerCase().includes(query) ||
                (tool.tags || []).some(tag => tag.toLowerCase().includes(query))
            ).slice(0, 10);
        }
        
        renderResults(results, totalCount) {
            if (!this.resultsList) return;
            
            // 更新计数
            if (this.resultsCount) {
                this.resultsCount.innerHTML = `找到 <strong class="text-slate-700">${totalCount}</strong> 个结果`;
            }
            
            // 渲染结果列表
            if (results.length === 0) {
                this.resultsList.innerHTML = `
                    <div class="px-4 py-8 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-slate-500">未找到相关工具</p>
                        <p class="text-sm text-slate-400 mt-1">试试其他关键词</p>
                    </div>
                `;
            } else {
                this.resultsList.innerHTML = results.map((result) => `
                    <a href="${result.url || '#'}" 
                       class="block px-4 py-3 hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-b-0"
                       target="_blank">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white flex-shrink-0">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-slate-900 truncate">${result.name || '未知工具'}</h4>
                                <p class="text-sm text-slate-500 line-clamp-2 mt-0.5">${result.description || ''}</p>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${(result.tags || []).slice(0, 3).map(tag => `
                                        <span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full">${tag}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('');
            }
            
            this.showResults();
        }
        
        showResults() {
            this.resultsBox?.classList.remove('hidden');
            this.isOpen = true;
        }
        
        hideResults() {
            this.resultsBox?.classList.add('hidden');
            this.isOpen = false;
        }
    }
    
    // 初始化搜索
    document.addEventListener('DOMContentLoaded', () => {
        new SearchEngine();
    });
</script>

<style>
    #search-results {
        animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
</style>
