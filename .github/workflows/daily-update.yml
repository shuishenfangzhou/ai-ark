name: Daily AI Tools Update

on:
  # ÂÆöÊó∂‰ªªÂä°ÔºöÊØèÂ§©ÂáåÊô® 0:00 ËøêË°å
  schedule:
    - cron: '0 0 * * *'
  
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
  
  # ÂΩì tools.json Êõ¥Êñ∞Êó∂Ëß¶Âèë
  push:
    paths:
      - 'data/tools.json'
      - 'agents/src/**'

jobs:
  # ‰ªªÂä°1: Ê≠ªÈìæÊ£ÄÊµã
  check-links:
    runs-on: ubuntu-latest
    outputs:
      has_dead_links: ${{ steps.check.outputs.dead_count > 0 }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./agents
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install httpx
      
      - name: Run dead link checker
        id: check
        working-directory: ./agents
        run: |
          source venv/bin/activate
          python -m src.link_checker
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊ≠ªÈìæ
          if grep -q "Ê≠ª‰∫°ÈìæÊé•:" link_check_report.txt; then
            DEAD_COUNT=$(grep -o '[0-9]\+ Ê≠ª‰∫°ÈìæÊé•' link_check_report.txt | grep -o '[0-9]\+' | head -1)
            echo "dead_count=$DEAD_COUNT" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ÂèëÁé∞ $DEAD_COUNT ‰∏™Ê≠ªÈìæ"
          else
            echo "dead_count=0" >> $GITHUB_OUTPUT
            echo "‚úÖ Ê≤°ÊúâÂèëÁé∞Ê≠ªÈìæ"
          fi
      
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: agents/link_check_report.txt

  # ‰ªªÂä°2: AI Êï∞ÊçÆÊõ¥Êñ∞
  update-tools:
    runs-on: ubuntu-latest
    needs: check-links
    # Â¶ÇÊûúÂèëÁé∞Â§ßÈáèÊ≠ªÈìæ(>10)ÔºåË∑≥ËøáÊõ¥Êñ∞
    if: needs.check-links.outputs.has_dead_links == 'false' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        working-directory: ./agents
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
      - name: Run update script
        working-directory: ./agents
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
        run: |
          source venv/bin/activate
          python -m src.main
          
      - name: Check for changes
        id: git-status
        run: |
          git status --porcelain
          git diff --stat data/tools.json
          
      - name: Commit changes
        if: steps.git-status.outputs.stdout != ''
        run: |
          git config user.name "AI Bot"
          git config user.email "bot@ai-ark.cn"
          git add data/tools.json agents/data/link_check_report.txt
          git commit -m "ü§ñ Auto-update: $(date +%Y-%m-%d) - Updated AI tools and link status"
          git push

  # ‰ªªÂä°3: ÊûÑÂª∫ÂíåÈÉ®ÁΩ≤
  deploy:
    needs: update-tools
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Astro site
        run: |
          npm run build
          
      # Pagefind Á¥¢Âºï
      - name: Index with Pagefind
        run: |
          npx pagefind --site dist --output-path dist/pagefind
      
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "dist,data/tools.json"
          target: ${{ secrets.DEPLOY_PATH }}
          strip_components: 0
      
      # ‰øÆÂ§çÁÇπÔºö‰ΩøÁî® env ‰∏≠ËΩ¨ÔºåÂΩªÂ∫ïËß£ÂÜ≥ "Unrecognized named-value" Êä•Èîô
      - name: Clear CDN cache
        env:
          CDN_URL: ${{ secrets.CDN_CLEAR_URL }}
        if: ${{ env.CDN_URL != '' }}
        run: |
          curl -X PURGE $CDN_URL
