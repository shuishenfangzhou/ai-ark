name: AI Tools Auto Update

# =========================================
# è‡ªåŠ¨æ›´æ–° AI å·¥å…·æ•°æ®
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
# =========================================

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œ (UTC æ—¶é—´)
    # å¯¹åº”åŒ—äº¬æ—¶é—´æ¯å¤©ä¸Šåˆ 10 ç‚¹
    - cron: '0 2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      message:
        description: 'æ›´æ–°è¯´æ˜'
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°æ•°æ®'
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿æ•°æ®æ— å˜åŒ–ï¼‰'
        required: false
        default: 'false'

jobs:
  update-data:
    name: Update AI Tools Data
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€ä»£ç 
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæ­£ç¡®è®¡ç®—ç‰ˆæœ¬
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 aiohttp lxml
      
      # 4. è¿è¡Œæ•°æ®çˆ¬å–è„šæœ¬
      - name: Run Scraper
        id: scraper
        run: |
          echo "å¼€å§‹çˆ¬å–æ•°æ®..."
          # ä½¿ç”¨ç®€åŒ–çš„åˆå¹¶è„šæœ¬
          python scraper/merge_data.py || echo "çˆ¬å–å®Œæˆ"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
          if [ -f "dist/toolsData.json" ]; then
            echo "æ•°æ®æ–‡ä»¶å·²æ›´æ–°"
            ls -lh dist/toolsData.json
          else
            echo "è­¦å‘Š: æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
          fi
      
      # 5. é…ç½® Git
      - name: Configure Git
        run: |
          git config user.name "AI-Ark-Bot"
          git config user.email "bot@ai-ark.com"
      
      # 6. æ£€æŸ¥å˜æ›´å¹¶æäº¤
      - name: Check and Commit Changes
        id: commit
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          CHANGES=$(git status --porcelain | wc -l)
          
          if [ "$CHANGES" -gt "0" ]; then
            echo "æ£€æµ‹åˆ° $CHANGES ä¸ªæ–‡ä»¶å˜æ›´"
            
            # è·å–å½“å‰æ—¥æœŸ
            DATE=$(date +%Y-%m-%d)
            
            # æ·»åŠ å˜æ›´æ–‡ä»¶
            git add dist/toolsData.json public/toolsData.json || true
            git add scraper/output/*.json 2>/dev/null || true
            
            # æäº¤
            git commit -m "chore: auto-update tools data ($DATE)

            - Updated by GitHub Actions
            - Data auto-crawl from ai-bot.cn
            - Total tools: $(python -c "import json; print(len(json.load(open('dist/toolsData.json'))))")" || echo "Nothing to commit"
            
            echo "COMMIT_STATUS=success" >> $GITHUB_OUTPUT
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
            echo "COMMIT_STATUS=no_changes" >> $GITHUB_OUTPUT
          fi
      
      # 7. æ¨é€åˆ°è¿œç¨‹
      - name: Push Changes
        if: steps.commit.outputs.COMMIT_STATUS == 'success'
        run: |
          git push origin main
      
      # 8. è¾“å‡ºç»“æœ
      - name: Summary
        run: |
          if [ "${{ steps.commit.outputs.COMMIT_STATUS }}" == "success" ]; then
            echo "âœ… æ•°æ®æ›´æ–°å®Œæˆå¹¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"
            echo "ğŸš€ 1Panel å°†è‡ªåŠ¨æ‹‰å–æœ€æ–°ä»£ç "
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ•°æ®éœ€è¦æ›´æ–°"
          fi

  # é€šçŸ¥ 1Panel (å¯é€‰)
  notify-1panel:
    name: Notify 1Panel (å¯é€‰)
    needs: update-data
    runs-on: ubuntu-latest
    if: needs.update-data.outputs.COMMIT_STATUS == 'success'
    
    steps:
      # å¦‚æœé…ç½®äº† 1Panel Webhookï¼Œå¯ä»¥åœ¨è¿™é‡Œè§¦å‘
      # - name: Trigger 1Panel Webhook
      #   run: |
      #     curl -X POST ${{ secrets.ONE_PANEL_WEBHOOK_URL }}
      #   continue-on-error: true
      - name: Show Info
        run: |
          echo "âœ… GitHub Actions å®Œæˆ"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š1Panel å°†é€šè¿‡ Webhook è‡ªåŠ¨æ‹‰å–æ›´æ–°"
          echo ""
          echo "å¦‚éœ€æ‰‹åŠ¨è§¦å‘ 1Panel æ›´æ–°ï¼š"
          echo "1. ç™»å½• 1Panel åå°"
          echo "2. ç½‘ç«™ â†’ AIæ–¹èˆŸ â†’ æ‹‰å–ä»£ç "
          echo "3. é‡å¯å®¹å™¨"
